#include "Battle.h"
#include "player.h"
#include "skill.h"
#include "item.h"
#include <stdarg.h>
#include <conio.h>
using namespace std;
Battle::Battle(Monster& monster)
{
	BattleSystem(monster);
}


Battle::~Battle()
{
}

void Battle::BattleSystem(Monster& monster) {
	while (1) {
		int battleget = 0;
		clrscr();
		battleget = BattleMenu(monster);
		while(1) {
			bool isCheck = false;
			int damage = 0;
			switch (battleget) {
			case 1:
				damage = p.attackDamage();
				Battlelog(monster,"이얍! 평타!");
				Battlelog(monster,"%y%s%w은/는 %r%d%w 데미지를 %y%s%w에게 주었다!", p.name, damage, monster.name);
				monster.beatenDamage(damage);
				isCheck = true;
				break;
			case 2:
				isCheck = ShowInventory(monster);
				break;
			case 3:
				isCheck = ShowSkills(monster);
				break;
			case 4:
				if (Run(monster)) {
					return;
				}
				isCheck = true;
				break;
			default:
				break;
			}
			if (isCheck)
				break;
		}
		AIBattle(monster);
	}
}

bool Battle::ShowInventory(Monster& monster) {
	char input = 0;
	while (1) {
		{
			int colm = 0;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "┌─────────────────────────────────┬──────────┐" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  ┌────────────┐                                    │                    │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  │ 빨 간  포 션  X  n개: 1│                                    │    E x i t :  4    │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  └────────────┘H P 를  5 0 만 큼  회 복 한 다.     │                    │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│                                                                  ├<Player>──────┤" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  ┌────────────┐                                    │ 000/000    000/000 │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  │ 하 얀  포 션  X  n개: 2│                                    ├<Monster> ─────┤" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  └────────────┘H P 를  1 0 0 만 큼  회 복 한 다.   │ 000/000      000   │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│                                                                  ├──────────┤" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  ┌────────────┐                                    │                    │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  │ 파 란  포 션  X  n개: 3│                                    │  행 동  선 택 :  n │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "│  └────────────┘A P 를  3 0 만 큼  회 복 한 다.     │                    │" << endl;
			gotoxy(30, 10 + colm);
			colm++;
			cout << "└─────────────────────────────────┴──────────┘" << endl;
			gotoxy(101, 15);
			cout << p.nHp << "/" << p.getMAXHP() << "    " << p.nAP << "/" << p.getMAXAP();
			gotoxy(101, 17);
			cout << monster.getHP() << "/" << monster.getMAXHP() << "      " << monster.getAP();
			gotoxy(54, 12);
			cout << p.item_list[4];
			gotoxy(54, 16);
			cout << p.item_list[5];
			gotoxy(54, 20);
			cout << p.item_list[6];
		}
		gotoxy(118, 20);
		input = getche();
		int inp = (int)input - 45;
		if (inp < 1 || inp>4)

			if (input == 4) {
				Boxscreen(monster);
				return false;
			}
			else {
				//아이템 사용
				if (p.item_list[inp] > 0) {
					Battlelog(monster, "%y%s%w은/는 %r%s%w을/를 사용했다!", p.name, item_name[inp]);
					//아이템 사용 함수 실행
					p.item_list[inp]--;
					return true;
				}
				else {
					_beep(523, 200);
					_beep(523, 200);
				}
			}
	}
	
}
bool Battle::ShowSkills(Monster& monster) {
	while (1) {
		gotoxy(30, 10);
		//cout << "┌────────────────────────────────────────────┐" << endl;
		//cout << "│                                                                                        │" << endl;
		//cout << "│                                                                                        │" << endl;
		//cout << "│                                                                                        │" << endl;
		//cout << "│                                                                                        │" << endl;
		//cout << "│                                                                                        │" << endl;
		//cout << "│                                                                                        │" << endl;
		//cout << "└────────────────────────────────────────────┘" << endl;
		//gotoxy(31, 11);
		//return true;
		cout << "┌────────────────────────────────────────────┐" << endl;
		cout << "│                                                                                        │" << endl;
		cout << "├────────────────────────────────────────────┤" << endl;
		gotoxy(35, 11);
		cout << p.name << "      HP   " << p.nHp << " / " << p.getMAXHP << "      AP   " << p.nAP << " / " << p.getMAXAP;
		int garo = 2;
		for (int i = 0; i < SKILL_NUM; i++) {
			if (p.sk_list[i]) {
				garo++;
				gotoxy(30, 10 + garo);
				cout << "│                                                                                        │" << endl;
				gotoxy(31, 10 + garo);
				cout << garo - 2 << ". " << sk_name[i] << "L v " <</*스킬 레벨<<*/"         A  P: "/*스킬 코스트*/;
			}
		}
		gotoxy(30, 11 + garo);
		cout << "├────────────────────────────────────────────┤" << endl;
		cout << "│                                                                                        │" << endl;
		cout << "└────────────────────────────────────────────┘" << endl;
		gotoxy(35, 12 + garo);
		cout << "Exit: 0             Get Number: n" << endl;
		gotoxy(68, 12 + garo);
		char input = getche();
		int inp = input - 48;
		if (!inp) {
			return false;
		}
		int counter = 0,num=0;
		for (num = 0; num < SKILL_NUM; num++) {
			//스킬 있는 번호 리턴
			counter += p.sk_list[num];
			if (counter == inp)
				break;
			else {
				return false;
			}
		}
		int damage = 0;
		if (p.nAP < 1/*스킬 사용 AP보다 낮다면*/) {
			return false;
			Battlelog(monster, "AP가 부족합니다!");
		}
		//스킬 사용 함수[num];
		//스킬 AP 소모
		Battlelog(monster,"%y%s%w은/는 %y%s%w을/를 사용했다!",p.name,sk_name[num]);
		return true;
	}
	
}
void Battle::Boxscreen(Monster& monster) {
	gotoxy(0, 0);
	monster.printASCII();
	gotoxy(0, 52);
	cout << "┌─────────────────────────────────────────────────────────────────────────┐";
	cout << "│                                                                                                                                                  │";
	cout << "│                                                                                                                                                  │";
	cout << "│                                                                                                                                                  │";
	cout << "│                                                                                                                                                  │";
	cout << "│                                                                                                                                                  │";
	cout << "│                                                                                                                                                  │";
	cout << "└─────────────────────────────────────────────────────────────────────────┘";
	gotoxy(0, 0);
}
void Battle::AIBattle(Monster& monster){
	while (1) {
		if (RandInt(2)) {
			int monsterdmg = monster.attackDamage();
			//몬스터 평타
			p.beatenDamage(monsterdmg);
			Battlelog(monster,"/*PlayerName*/은/는 %r%d%w의 데미지를 입었다!", monsterdmg);
			break;
		}
		else {
			//몬스터스킬
			for (int i = 0; i < SKILL_NUM; i++) {
				if (monster.sk_list[i]) {//스킬 있을때
					if (monster.getAP() >1 ) {//스킬사용ap가 현재AP보다 높으면
						int damage = 0;
						Battlelog(monster,"%y%s%w은/는%y%s%w을/를 사용했다!", monster.name, monster.sk_list[i]);
						Battlelog(monster,"%y%s%w은/는 %r%d%w의 데미지를 입었다!", p.name, damage);
						p.beatenDamage(damage);
						break;
					}
				}
			}
		}
	}
}
bool Battle::Run(Monster& monster) {
	if (RandInt(3)) {
		Battlelog(monster, "%y&s%w은/는 %y%s%w에게서 무사히 도망쳤다!", p.name, monster.name);
		return true;
	}
	else
		Battlelog(monster, "%y%s%w은/는 %y%s%w에게서 도망치는데 실패했다!", p.name, monster.name);
		return false;
}

void Battle::Battlelog(Monster& monster,const char* Format, ...) {
	va_list list;
	clrscr();
	//아스키 출력
	Boxscreen(monster);
	int i;
	int* idx = (int*)&Format;
	idx++;
	while (*Format != NULL) {
		if (*Format == '%') {
			switch (*(Format + 1))
			{
			case 'd':     // int 형 매개변수 출력  
				cout<<*(int*)idx;
				idx++;
				Format += 2;
				break;
			case 'c':     // char 형 매개변수 출력  
				cout << *(int*)idx;
				idx++;
				Format += 2;
				break;
			case 'f':     // double 형 매개변수 출력  
				cout << *(int*)idx;
				idx++;    // double 형은 8byte를 차지하기 때문에 4byte씩 2번 뛰어 넘는다.
				idx++;
				Format += 2;
				break;
			case 's':     // 문자열 매개변수 출력  
				cout << *(int*)idx;
				idx++;
				Format += 2;
				break;
			case 'y':     // 옐로우 색
				setColor(YELLOW,BLACK);
				Format += 2;
				break;
			case 'w':     // 색 조절 블랙  
				setColor(WHITE, BLACK);
				Format += 2;
				break;
			case 'r':     // 색 조절 레드 
				setColor(RED, BLACK);
				Format += 2;
				break;

			default:
				break;
			}
		}
		else
		{
			cout << *Format;
			Format++;
		}
	}
}
int Battle::BattleMenu(Monster& monster) {
	while (1) {
		monster.printASCII();
		gotoxy(0, 52);
		cout << "┌─────────────────────────────────────────────────────────────────────────┐";
		cout << "│ ┌──────────────────────┐                                           ┌──────────────────────┐      │";
		cout << "│ │      ▶     1.    일 반  공 격             │                                           │        ▶     2.    가 방  열 기           │      │";
		cout << "│ └──────────────────────┘                                           └──────────────────────┘      │";
		cout << "│ ┌──────────────────────┐                                           ┌──────────────────────┐      │";
		cout << "│ │      ▶     3.    스 킬  공 격             │                                           │        ▶     4.    전 투  도 주           │      │";
		cout << "│ └──────────────────────┘             행 동  선 택 :                └──────────────────────┘      │";
		cout << "└─────────────────────────────────────────────────────────────────────────┘";
		gotoxy(80, 57);
		char num=getche();
		gotoxy(0, 0);
		if (num< 49 || num>52) {
		}
		else {
			return (int)(num-48);
		}
	}
}